name: Release & Version Bump

on:
  push:
    branches:
      - master

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write # REQUIRED: Allow pushing tags and commits
      packages: write  # Needed to upload the JAR

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.ADMIN_PAT }}
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
          server-id: github

      # Step 1: Compile & Enforce Coverage (Fails if < 90%)
      - name: Build & Check Coverage
        run: mvn clean verify

  sonar-analysis:
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      contents: write # REQUIRED: Allow pushing tags and commits
      packages: write  # Needed to upload the JAR

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.ADMIN_PAT }}
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
          server-id: github

      # Step 2: Sonar Analysis
      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
          
      - name: Build and analyze
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.projectKey=Brick-Framework_Brick-Utilities -Dsonar.qualitygate.wait=true
   
  release:
    needs: sonar-analysis
    runs-on: ubuntu-latest
    permissions:
      contents: write # REQUIRED: Allow pushing tags and commits
      packages: write  # Needed to upload the JAR

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.ADMIN_PAT }}
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
          server-id: github

      # Step 3: Configure Git User (Needed for tagging and committing)
      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'

      # Step 4: Publish to Github Packages
      - name: Publish Package
        # We point Maven to the settings.xml generated by the setup-java step
        run: mvn deploy -DskipTests
        env:
          # This specific env var name (GITHUB_TOKEN) is mapped automatically 
          # by the setup-java action to the 'server-id' credential.
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 5: Extract Current Version & Create Tag
      - name: Tag Current Version
        run: |
          # 1. Get the version from pom.xml (e.g., 1.4.5)
          CURRENT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Current version is: $CURRENT_VERSION"
          
          # 2. Create the tag (e.g., v1.4.5)
          git tag -a "v$CURRENT_VERSION" -m "Release v$CURRENT_VERSION"
          
          # 3. Push the tag to GitHub
          git push origin "v$CURRENT_VERSION"

      # Step 6: Bump Version (1.4.5 -> 1.4.6)
      - name: Bump Version & Push
        run: |
          # 1. Increment the patch version
          # This command parses the version and increases the 'nextIncrementalVersion'
          mvn build-helper:parse-version versions:set \
            -DnewVersion=\${parsedVersion.majorVersion}.\${parsedVersion.minorVersion}.\${parsedVersion.nextIncrementalVersion} \
            -DgenerateBackupPoms=false

          # 2. Verify new version
          NEW_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "New version is: $NEW_VERSION"

          # 3. Commit and Push the change
          # [skip ci] is CRITICAL to prevent an infinite loop of builds
          git add pom.xml
          git commit -m "chore: bump version to $NEW_VERSION [skip ci]"
          git push 